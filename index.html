<html>

<head>
    <meta charset="UTF-8">
    <script src="jquery-2.1.4.min.js"></script>
    <script src="d3.v5.min.js"></script>
    <style>
        body {
            background-color: #fff;
            padding-top: 20px;
            padding-left: 25%;
        }

        .tooltip {
            position: absolute;
            pointer-events: none;
            font-size: 8px;
            opacity: 1;
            width: 200px;
            /* height: 150px; */
            border-radius: 5px;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            padding-left: 100px;
            visibility: hidden;
        }

        .tooltip .item {
            margin: 3px 0;
        }
        #scatter{
            position: relative;
        }
        #legend {
            position: absolute;
            left:80px;
            top: 40px;
            padding: 10px;
            border: 1px solid red;
            width: 170px;
        }
    </style>
</head>

<body>
    
    <div class="desc">
        <h3> About scatter :</h3>
        <p>This scatterplot shows the relationship between attendance and graduation rates</p>
        <p>for Chicago Public Schools students. Data Source:
            <a href="https://catalog.data.gov/dataset/chicago-public-schools-school-progress-reports-sy2324">data.gov</a>.
        </p>

    </div>
    <div id="scatter">
        <div id="legend"></div>
    </div>
    <script type="text/javascript">
        let names = ['Very Strong', 'Strong', 'Neutral', 'Weak', 'Very Weak', 'Not enough data'];
        let colors = ['gold', 'khaki', 'lavender', 'salmon', 'red', 'gray']

        let html = names.map((name, index) => {
            return `<div style="margin:6px 0;display:flex;justify-content:space-between;"><div>${name}:</div><div style="width:20px;height:20px;background:${colors[index]};border-radius:10px;"></div></div>`
        })
        $("#legend").append(html)

        d3.csv('https://cdn.jsdelivr.net/gh/pengxiangli666/567/Chicago_Public_Schools_-_School_Progress_Reports_SY2324.csv').then(rows => {

            let datasets = []
            let chandler = [], joey = [], monica = [], phoebe = [], rachel = [], ross = [];
            //             let VERYSTRONG = gold, Strong = khaki, Neutral = lavender, Weak = salmon, Very Weak = 
            // red, Not enough data = gray
            let VeryStrong = [], Strong = [], Neutral = [], Weak = [], VeryWeak = [], NotEnoughData = []
            let xmin = 1000, xmax = 0, ymin = 100, ymax = 0; // 默认初始值为0
            rows.forEach((item, idx) => {
                const { School_ID, Student_Attendance_Year_1_Pct, Student_Attendance_Year_2_Pct, Graduation_4_Year_School_Pct_Year_2, School_Survey_Supportive_Environment } = item;
                if (Student_Attendance_Year_1_Pct.trim() != '' && Student_Attendance_Year_2_Pct.trim() != '' && Graduation_4_Year_School_Pct_Year_2.trim() != '' && School_Survey_Supportive_Environment.trim() != '') {
                    let x = (Number(Student_Attendance_Year_1_Pct) + Number(Student_Attendance_Year_2_Pct)) / 2
                    let y = Number(Graduation_4_Year_School_Pct_Year_2)
                    if (x < xmin) xmin = x;
                    if (x > xmax) xmax = x;
                    if (y < ymin) ymin = y;
                    if (y > ymax) ymax = y;

                    let cell = [x, y, School_ID]

                    switch (School_Survey_Supportive_Environment) {
                        case 'VERY STRONG':
                            VeryStrong.push([...cell, 'gold'])
                            break;
                        case 'STRONG':
                            Strong.push([...cell, 'khaki'])
                            break;
                        case 'NEUTRAL':
                            Neutral.push([...cell, 'lavender'])
                            break;
                        case 'WEAK':
                            Weak.push([...cell, 'salmon'])
                            break;
                        case 'VERY WEAK':
                            VeryWeak.push([...cell, 'red'])
                            break;
                        case 'NOT ENOUGH DATA':
                            NotEnoughData.push([...cell, 'gray'])
                            break;
                        default:
                            break;
                    }
                }

            })

            datasets.push(VeryStrong)
            datasets.push(Strong)
            datasets.push(Neutral)
            datasets.push(Weak)
            datasets.push(VeryWeak)
            datasets.push(NotEnoughData)

            console.log(datasets)
            let dataset = datasets[0]
            var formator = d3.format(".1%")  //刻度样式自定义，也可以通过formator(10)测试。
            var h = 700;
            var w = 800;
            svg = d3.select("#scatter").append("svg");
            svg.attr("height", h)
                .attr("width", w);
            /*设置比例尺*/
            padding = 35;
            var xscale = d3.scaleLinear()
                // .domain([xmin, xmax])
                .domain([0, 100])
                .range([0 + padding, w - padding]);
            var yscale = d3.scaleLinear()
                // .domain([ymin, ymax])
                .domain([0, 100])
                .range([h - padding, 0 + padding]);//改变下y坐标的延伸方向
            var rscale = d3.scaleLinear()
                .domain([0, d3.max(dataset, function (d) {
                    return d[1];
                })])
                .range([10, 10]);//将半径映射到10-10,y越大，r越大，但视觉上不合理

            const header = [""]; //不同学校入学升学率散点图
            const headers = svg.append("g");
            headers.selectAll("text")
                .data(header)
                .enter()
                .append("text")
                .attr("stroke", "black")
                .attr("transform", `translate(${100}, ${30})`)
                .style("font-size", "25px")
                .text(d => d)
                .on('click', function (d, i) {
                    // d3.select("#tooltip").remove();
                    tooltip.style('visibility', 'hidden')
                });

            /*坐标轴声生成*/
            var xaxis = d3.axisBottom()
                .scale(xscale)
                .ticks(10)
            // .tickFormat(formator);
            var yaxis = d3.axisLeft()
                .scale(yscale)
                .ticks(10);
            /*g是group的意思，跟html中div作用一样*/
            svg.append("g")
                .attr("class", "xaxis")
                .attr("transform", "translate(0," + (h - padding) + ")")
                .call(xaxis);
            svg.append("g")
                .attr("class", "yaxis")
                .attr("transform", "translate(" + (padding) + ",0)")
                .call(yaxis);

            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("background-color", "#d3d3d3")
                // .style("border-radius", "3px")
                .style("padding", "20px");

            datasets.forEach((dataset, i) => {
                svg.append("g")   //将所有的circle添加到g元素中，并设置id以后方便引用
                    .attr("id", "circles")
                    .selectAll("circle")
                    .data(dataset)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) {
                        return xscale(d[0]);
                    })
                    .attr("cy", function (d) {
                        return yscale(d[1]);
                    })
                    .attr("r", function (d) {
                        return rscale(d[1]);
                    })
                    .attr("fill", function (d, i) {
                        return d[3]
                    })
                    .on('mouseover', function (d, i) {
                        d3.select(this).attr("fill", "#9bf80c")
                        let School_ID = d[2]
                        let findItem = rows.find(item => item.School_ID === School_ID)
                        var x = d3.event.pageX;
                        var y = d3.event.pageY;
                        d3.select("#tooltip").remove();
                        tooltip.html(`
                            <div>
                               <div> <b>Short_Name: </b> ${findItem.Short_Name} </div>
                               <div> <b>Address: </b> ${findItem.Address} </div>
                               <div> <b>Attendance  percentage: </b> ${d[0]} </div>
                               <div> <b>Graduation  percentage: </b> ${d[1]} </div>
                            </div>
                        `).style("visibility", "visible")
                            // .style('height', '80px')
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px")
                    }).on("mouseout", function (d, i) {
                        d3.select(this).attr("fill", d[3])
                        tooltip.style('visibility', 'hidden')
                    });
            })

        })

    </script>
</body>

</html>